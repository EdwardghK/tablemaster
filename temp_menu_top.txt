import React, { useState, useEffect, useContext } from "react";
import Header from "@/components/common/Header";
import BottomNav from "@/components/common/BottomNav";
import { cn } from "@/utils";
import { AppContext } from "@/context/AppContext.jsx";
import { Button } from "@/components/ui/Button";
import { Plus, Trash2, Pencil } from "lucide-react";
import AllergenBadge, { COMMON_ALLERGENS } from "@/components/common/AllergenBadge";
import CategoryTabs from "@/components/menu/CategoryTabs";
import { ChangeRequests } from "@/api/changeRequests";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from "@/components/ui/Dialog";
import { Input } from "@/components/ui/Input";
import { Textarea } from "@/components/ui/Textarea";
import { Label } from "@/components/ui/Label";
import { Checkbox } from "@/components/ui/Checkbox";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/Select";
import { toast } from "sonner";
import { MenuStorage } from "@/api/localStorageHelpers/menu";

// Must match Supabase slugs from menu_categories table
const CATEGORIES = [
  "appetizers",
  "salads",
  "caviar",
  "chilled_seafood",
  "steaks",
  "main_courses",
  "sides",
  "additions",
  "sauces",
  "desserts",
  "pf_main",
];

const STEAK_COUNTRIES = ["CAD", "AUS", "US", "ARG", "JAP"];
const STEAK_ORIGINS = [
  "High River, AB",
  "Winnipeg, MB",
  "PEI",
  "Martin Farm, Elora, ON",
  "Pinnacle Farms, Queensland",
  "Black Opal, Victoria",
  "Miyazaki Prefecture, JAP",
  "Hyogo Prefecture, JAP",
];
const STEAK_CUTS = [
  "Tenderloin",
  "Striploin",
  "Ribeye",
  "T-Bone",
  "Porter House",
  "Tomahawk",
  "Flat iron",
  "Texudo",
];

// ----------------- Main Component -----------------
export default function MenuPage() {
  const {
    menuItems: ctxMenuItems,
    setMenuItems: setCtxMenuItems,
    requiresApproval,
    user,
  } = useContext(AppContext);

  const [menuItems, setMenuItems] = useState(ctxMenuItems || []);
  const [prefixedMenu, setPrefixedMenu] = useState(null);
  const [categoryFilter, setCategoryFilter] = useState("all");
  const [itemModal, setItemModal] = useState({ open: false, item: null });
  const [detailModal, setDetailModal] = useState({ open: false, item: null });
  const [unavailableMap, setUnavailableMap] = useState({});
  const [steakOriginFilter, setSteakOriginFilter] = useState("all");
  const formatSteakLabel = (mi) => {
    const parts = [
      mi.weight_oz ? `${mi.weight_oz}oz` : "",
      mi.country || "",
      mi.name || "",
    ]
      .filter(Boolean)
      .join(" ")
      .trim();
    return parts;
  };
  const formatFarmLine = (mi) => mi?.origin || mi?.farm_detail || "";
  const formatAging = (mi) => {
    if (!mi?.aging_days || Number(mi.aging_days) <= 0) return "";
    return `${mi.aging_days} Days Dry-Aged`;
  };
  const [form, setForm] = useState({
    name: "",
    price: "",
    category: CATEGORIES[0],
    description: "",
    allergens: "",
    mods: "",
    country: "",
    origin: "",
    weight_oz: "",
    cut: "",
    aging_days: "",
    farm_detail: "",
  });

  // ----------------- Load Menu Items -----------------
  const loadMenu = async () => {
    try {
      const items = await MenuStorage.getMenuItems();
      const map = MenuStorage.getUnavailableMap();
      setUnavailableMap(map);
      setMenuItems(items || []);
      setCtxMenuItems?.(items || []);
    } catch (err) {
      console.error(err);
      toast.error("Failed to load menu items");
      setMenuItems([]);
      setCtxMenuItems?.([]);
    }
  };

  useEffect(() => {
    loadMenu();
    loadPrefixed();
  }, []);

  // ----------------- Save (Add / Edit) -----------------
  const handleSaveItem = async () => {
    if (!form.name.trim()) {
      toast.error("Name is required");
      return;
    }
    if (!form.category) {
      toast.error("Please select a category");
      return;
    }
    if (form.category === "steaks" && !form.country) {
      toast.error("Country is required for steaks");
      return;
    }
    if (form.category === "steaks" && !form.origin?.trim()) {
      toast.error("Origin is required for steaks");
      return;
    }
    if (form.category === "steaks" && !form.cut?.trim()) {
      toast.error("Cut is required for steaks");
      return;
    }
    if (
      form.category === "steaks" &&
      (form.weight_oz === "" || Number(form.weight_oz) <= 0)
    ) {
      toast.error("Weight (oz) is required for steaks");
      return;
    }

    const isSteak = form.category === "steaks";

    const payload = {
      name: form.name.trim(),
      price: Number(form.price) || 0,
      category: (form.category || "").trim().toLowerCase(),
      description: form.description,
      allergens: parseAllergens(form.allergens),
      common_mods: parseMods(form.mods),
      country: isSteak ? (form.country || "").trim() : null,
      origin: isSteak ? (form.origin || "").trim() : null,
      weight_oz:
        isSteak && form.weight_oz !== "" ? Number(form.weight_oz) : null,
    cut: isSteak ? (form.cut || "").trim() : null,
    aging_days:
      isSteak && form.aging_days !== ""
        ? Number(form.aging_days)
        : null,
    farm_detail: (form.farm_detail || "").trim() || null,
  };
    if (!payload.allergens.length) {
      payload.allergens = ["None"];
    }

    const saveDirect = async () => {
      if (itemModal.item?.id) {
        await MenuStorage.updateMenuItem(itemModal.item.id, payload);
        toast.success("Menu item updated");
      } else {
        await MenuStorage.createMenuItem(payload);
        toast.success("Menu item added");
      }
      await loadMenu();
    };
